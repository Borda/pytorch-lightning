# Python package
# Create and test a Python package on multiple Python versions.
# Add steps that analyze code, save the dist with the build record, publish to a PyPI-compatible index, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/python

trigger:
  branches:
    include:
      - '*'  # must quote since "*" is a YAML reserved character; we want a string
pr:
  - master
  - release/*

pool: cpu-agent-pool
strategy:
  matrix:
    Python36:
      python.version: '3.6'
    Python37:
      python.version: '3.7'
    Python38:
      python.version: '3.8'

steps:
# seems not supported on own machine
#- task: UsePythonVersion@0
#  inputs:
#    versionSpec: '$(python.version)'
#  displayName: 'Use Python $(python.version)'
- script: |
    sudo apt-get install -y python$(python.version)
    sudo update-alternatives --install /usr/bin/python python /usr/bin/python$(python.version) 1
    sudo update-alternatives --config python
  displayName: 'Install python'

- script: |
    python --version
    python -m pip install "pip==20.1"
    pip install --requirement requirements.txt --find-links https://download.pytorch.org/whl/cpu/torch_stable.html --quiet --upgrade
    pip install --requirement ./requirements/devel.txt --find-links https://download.pytorch.org/whl/cpu/torch_stable.html --quiet --upgrade
    pip --version
    pip list
  displayName: 'Install dependencies'

- script: |
    cd legacy
    # wget is simpler but does not work on Windows
    python -c "from urllib.request import urlretrieve ; urlretrieve('https://pl-public-data.s3.amazonaws.com/legacy/checkpoints.zip', 'checkpoints.zip')"
    ls -l .
    unzip -o checkpoints.zip
    ls -l checkpoints/
  displayName: 'Get legacy checkpoints'

- script: |
    coverage run --source pytorch_lightning -m pytest pytorch_lightning tests pl_examples -v --durations=50
  displayName: 'Testing'

- script: |
    coverage report
    coverage xml
  displayName: 'Statistics'
